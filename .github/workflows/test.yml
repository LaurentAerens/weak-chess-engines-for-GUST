name: Test Chess Engines

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Test engine imports
      run: |
        python -c "import sys; import os; sys.path.insert(0, os.path.join(os.getcwd(), 'src'));
        from engines.random_engine import RandomEngine
        from engines.alphabetical_engine import AlphabeticalEngine
        from engines.reverse_alphabetical_engine import ReverseAlphabeticalEngine
        from engines.pi_engine import PiEngine
        from engines.euler_engine import EulerEngine
        from engines.suicide_king_engine import SuicideKingEngine
        from engines.blunder_engine import BlunderEngine
        from engines.greedy_capture_engine import GreedyCaptureEngine
        from engines.shuffle_engine import ShuffleEngine
        from engines.anti_positional_engine import AntiPositionalEngine
        from engines.color_square_engine import ColorSquareEngine
        from engines.opposite_color_square_engine import OppositeColorSquareEngine
        from engines.swarm_engine import SwarmEngine
        from engines.huddle_engine import HuddleEngine
        from engines.runaway_engine import RunawayEngine
        from engines.mirror_y_engine import MirrorYEngine
        from engines.mirror_x_engine import MirrorXEngine
        from engines.reverse_start_engine import ReverseStartEngine
        from engines.CCCP_engine import CCCPEngine
        from engines.passafist_engine import PassafistEngine
        from engines.single_player_engine import SinglePlayerEngine
        from engines.strangler_engine import StranglerEngine
        from engines.mover_engine import MoverEngine
        from engines.opening_book_engine import OpeningBookEngine
        from base_engine import BaseUCIEngine
        print('All engines imported successfully!')"

    - name: Test engine instantiation
      run: |
        python -c "import sys; import os; sys.path.insert(0, os.path.join(os.getcwd(), 'src'));
        from engines.random_engine import RandomEngine
        from engines.alphabetical_engine import AlphabeticalEngine
        from engines.reverse_alphabetical_engine import ReverseAlphabeticalEngine
        from engines.pi_engine import PiEngine
        from engines.euler_engine import EulerEngine
        from engines.suicide_king_engine import SuicideKingEngine
        from engines.blunder_engine import BlunderEngine
        from engines.greedy_capture_engine import GreedyCaptureEngine
        from engines.shuffle_engine import ShuffleEngine
        from engines.anti_positional_engine import AntiPositionalEngine
        from engines.color_square_engine import ColorSquareEngine
        from engines.opposite_color_square_engine import OppositeColorSquareEngine
        from engines.swarm_engine import SwarmEngine
        from engines.huddle_engine import HuddleEngine
        from engines.runaway_engine import RunawayEngine
        from engines.mirror_y_engine import MirrorYEngine
        from engines.mirror_x_engine import MirrorXEngine
        from engines.reverse_start_engine import ReverseStartEngine
        from engines.CCCP_engine import CCCPEngine
        from engines.passafist_engine import PassafistEngine
        from engines.single_player_engine import SinglePlayerEngine
        from engines.strangler_engine import StranglerEngine
        from engines.mover_engine import MoverEngine
        from engines.opening_book_engine import OpeningBookEngine

        engines = [RandomEngine(), AlphabeticalEngine(), ReverseAlphabeticalEngine(), PiEngine(), EulerEngine(), SuicideKingEngine(), BlunderEngine(), GreedyCaptureEngine(), ShuffleEngine(), AntiPositionalEngine(), ColorSquareEngine(), OppositeColorSquareEngine(), SwarmEngine(), HuddleEngine(), RunawayEngine(), MirrorYEngine(), MirrorXEngine(), ReverseStartEngine(), CCCPEngine(), PassafistEngine(), SinglePlayerEngine(), StranglerEngine(), MoverEngine(), OpeningBookEngine()]
        for engine in engines:
          print(f'Created {engine.name} by {engine.author}')
          print('All engines created successfully!')"

    - name: Test engine move generation
      run: |
        python -c "import sys; import os; import chess; sys.path.insert(0, os.path.join(os.getcwd(), 'src'));
        from engines.random_engine import RandomEngine
        from engines.alphabetical_engine import AlphabeticalEngine
        from engines.reverse_alphabetical_engine import ReverseAlphabeticalEngine
        from engines.pi_engine import PiEngine
        from engines.euler_engine import EulerEngine
        from engines.suicide_king_engine import SuicideKingEngine
        from engines.blunder_engine import BlunderEngine
        from engines.greedy_capture_engine import GreedyCaptureEngine
        from engines.shuffle_engine import ShuffleEngine
        from engines.anti_positional_engine import AntiPositionalEngine
        from engines.color_square_engine import ColorSquareEngine
        from engines.opposite_color_square_engine import OppositeColorSquareEngine
        from engines.swarm_engine import SwarmEngine
        from engines.huddle_engine import HuddleEngine
        from engines.runaway_engine import RunawayEngine
        from engines.mirror_y_engine import MirrorYEngine
        from engines.mirror_x_engine import MirrorXEngine
        from engines.reverse_start_engine import ReverseStartEngine
        from engines.CCCP_engine import CCCPEngine
        from engines.passafist_engine import PassafistEngine
        from engines.single_player_engine import SinglePlayerEngine
        from engines.strangler_engine import StranglerEngine
        from engines.mover_engine import MoverEngine
        from engines.opening_book_engine import OpeningBookEngine

        engines = [RandomEngine(), AlphabeticalEngine(), ReverseAlphabeticalEngine(), PiEngine(), EulerEngine(), SuicideKingEngine(), BlunderEngine(), GreedyCaptureEngine(), ShuffleEngine(), AntiPositionalEngine(), ColorSquareEngine(), OppositeColorSquareEngine(), SwarmEngine(), HuddleEngine(), RunawayEngine(), MirrorYEngine(), MirrorXEngine(), ReverseStartEngine(), CCCPEngine(), PassafistEngine(), SinglePlayerEngine(), StranglerEngine(), MoverEngine(), OpeningBookEngine()]
        for engine in engines:
          engine.board = chess.Board()
          move = engine.get_best_move(0.1)
          if move and move in engine.board.legal_moves:
            print(f'{engine.name}: Generated legal move {move}')
          else:
            print(f'ERROR: {engine.name} failed to generate a legal move')
            sys.exit(1)
        print('All engines generated legal moves successfully!')"

  build-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Test PyInstaller build
      run: |
        # Test building one engine to ensure PyInstaller works
        pyinstaller --onefile --name test_random_engine scripts/random_engine.py
        
        # Check if executable was created
        if [ -f "dist/test_random_engine" ]; then
          echo "PyInstaller build successful!"
          ls -la dist/
        else
          echo "PyInstaller build failed!"
          exit 1
        fi