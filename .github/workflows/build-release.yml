name: Build and Release Chess Engines

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number for the release'
        required: true
        default: 'v1.0.0'
      notes:
        description: 'Additional release notes/comments'
        required: false
        default: ''

# Grant the workflow permission to create releases using GITHUB_TOKEN
permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
        python-version: ['3.9']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build executables
      run: |
        # Use the repository build helper which already sets --paths and hidden-imports
        # This ensures PyInstaller bundles the `src` package (including `engines`) and avoids
        # ModuleNotFoundError at runtime. It also keeps CI in sync with local builds.
        python build.py

    - name: Prepare artifacts (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # Create release directory
        mkdir release
        
        # Copy executables and rename with .exe extension
        copy "dist\random_engine_${{ matrix.os }}.exe" "release\random_engine_windows.exe"
        copy "dist\alphabetical_engine_${{ matrix.os }}.exe" "release\alphabetical_engine_windows.exe"
        copy "dist\reverse_alphabetical_engine_${{ matrix.os }}.exe" "release\reverse_alphabetical_engine_windows.exe"
        copy "dist\pi_engine_${{ matrix.os }}.exe" "release\pi_engine_windows.exe"
        copy "dist\euler_engine_${{ matrix.os }}.exe" "release\euler_engine_windows.exe"
        copy "dist\suicide_king_engine_${{ matrix.os }}.exe" "release\suicide_king_engine_windows.exe"
        copy "dist\blunder_engine_${{ matrix.os }}.exe" "release\blunder_engine_windows.exe"
        copy "dist\greedy_capture_engine_${{ matrix.os }}.exe" "release\greedy_capture_engine_windows.exe"
        copy "dist\shuffle_engine_${{ matrix.os }}.exe" "release\shuffle_engine_windows.exe"
        copy "dist\anti_positional_engine_${{ matrix.os }}.exe" "release\anti_positional_engine_windows.exe"
        copy "dist\color_square_engine_${{ matrix.os }}.exe" "release\color_square_engine_windows.exe"
        copy "dist\opposite_color_square_engine_${{ matrix.os }}.exe" "release\opposite_color_square_engine_windows.exe"
        copy "dist\swarm_engine_${{ matrix.os }}.exe" "release\swarm_engine_windows.exe"
        copy "dist\huddle_engine_${{ matrix.os }}.exe" "release\huddle_engine_windows.exe"
        copy "dist\runaway_engine_${{ matrix.os }}.exe" "release\runaway_engine_windows.exe"
        copy "dist\mirror_y_engine_${{ matrix.os }}.exe" "release\mirror_y_engine_windows.exe"
        copy "dist\mirror_x_engine_${{ matrix.os }}.exe" "release\mirror_x_engine_windows.exe"
        copy "dist\reverse_start_engine_${{ matrix.os }}.exe" "release\reverse_start_engine_windows.exe"
        copy "dist\CCCP_engine_${{ matrix.os }}.exe" "release\CCCP_engine_windows.exe"
        copy "dist\passafist_engine_${{ matrix.os }}.exe" "release\passafist_engine_windows.exe"
        copy "dist\single_player_engine_${{ matrix.os }}.exe" "release\single_player_engine_windows.exe"
        copy "dist\strangler_engine_${{ matrix.os }}.exe" "release\strangler_engine_windows.exe"
        copy "dist\mover_engine_${{ matrix.os }}.exe" "release\mover_engine_windows.exe"
        copy "dist\opening_book_engine_${{ matrix.os }}.exe" "release\opening_book_engine_windows.exe"
        copy "dist\rare_opening_book_engine_${{ matrix.os }}.exe" "release\rare_opening_book_engine_windows.exe"
        copy "dist\lawyer_engine_${{ matrix.os }}.exe" "release\lawyer_engine_windows.exe"
        copy "dist\criminal_engine_${{ matrix.os }}.exe" "release\criminal_engine_windows.exe"
        copy "dist\paralegal_engine_${{ matrix.os }}.exe" "release\paralegal_engine_windows.exe"

        # PowerShell syntax for file existence and copying
        if (Test-Path "src\engines\book\opening_book.db") {
          Copy-Item "src\engines\book\opening_book.db" "release\opening_book.db"
        }
        if (Test-Path "src\engines\book\opening_book_rare.db") {
          Copy-Item "src\engines\book\opening_book_rare.db" "release\opening_book_rare.db"
        }

    - name: Prepare artifacts (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Create release directory
        mkdir -p release
        
        # Copy executables with proper naming
        cp "dist/random_engine_${{ matrix.os }}" "release/random_engine_linux"
        cp "dist/alphabetical_engine_${{ matrix.os }}" "release/alphabetical_engine_linux"
        cp "dist/reverse_alphabetical_engine_${{ matrix.os }}" "release/reverse_alphabetical_engine_linux"
        cp "dist/pi_engine_${{ matrix.os }}" "release/pi_engine_linux"
        cp "dist/euler_engine_${{ matrix.os }}" "release/euler_engine_linux"
        cp "dist/suicide_king_engine_${{ matrix.os }}" "release/suicide_king_engine_linux"
        cp "dist/blunder_engine_${{ matrix.os }}" "release/blunder_engine_linux"
        cp "dist/greedy_capture_engine_${{ matrix.os }}" "release/greedy_capture_engine_linux"
        cp "dist/shuffle_engine_${{ matrix.os }}" "release/shuffle_engine_linux"
        cp "dist/anti_positional_engine_${{ matrix.os }}" "release/anti_positional_engine_linux"
        cp "dist/color_square_engine_${{ matrix.os }}" "release/color_square_engine_linux"
        cp "dist/opposite_color_square_engine_${{ matrix.os }}" "release/opposite_color_square_engine_linux"
        cp "dist/swarm_engine_${{ matrix.os }}" "release/swarm_engine_linux"
        cp "dist/huddle_engine_${{ matrix.os }}" "release/huddle_engine_linux"
        cp "dist/runaway_engine_${{ matrix.os }}" "release/runaway_engine_linux"
        cp "dist/mirror_y_engine_${{ matrix.os }}" "release/mirror_y_engine_linux"
        cp "dist/mirror_x_engine_${{ matrix.os }}" "release/mirror_x_engine_linux"
        cp "dist/reverse_start_engine_${{ matrix.os }}" "release/reverse_start_engine_linux"
        cp "dist/CCCP_engine_${{ matrix.os }}" "release/CCCP_engine_linux"
        cp "dist/passafist_engine_${{ matrix.os }}" "release/passafist_engine_linux"
        cp "dist/single_player_engine_${{ matrix.os }}" "release/single_player_engine_linux"
        cp "dist/strangler_engine_${{ matrix.os }}" "release/strangler_engine_linux"
        cp "dist/mover_engine_${{ matrix.os }}" "release/mover_engine_linux"
        cp "dist/opening_book_engine_${{ matrix.os }}" "release/opening_book_engine_linux"
        cp "dist/rare_opening_book_engine_${{ matrix.os }}" "release/rare_opening_book_engine_linux"
        cp "dist/lawyer_engine_${{ matrix.os }}" "release/lawyer_engine_linux"
        cp "dist/criminal_engine_${{ matrix.os }}" "release/criminal_engine_linux"
        cp "dist/paralegal_engine_${{ matrix.os }}" "release/paralegal_engine_linux"

        # copy sqlite opening book into release if present
        if [ -f src/engines/book/opening_book.db ]; then
          cp src/engines/book/opening_book.db release/opening_book.db || true
        fi
        if [ -f src/engines/book/opening_book_rare.db ]; then
          cp src/engines/book/opening_book_rare.db release/opening_book_rare.db || true
        fi

        # Make executables... executable
        chmod +x release/*

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: chess-engines-${{ matrix.os }}
        path: release/

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4


    - name: Install tournament dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-chess

    - name: Run Tournament and Export Results
      run: |
        python tournament.py
        mkdir -p final_release
        cp tournament_results.csv final_release/
        cp tournament_games.pgn final_release/
        echo "Tournament results:" > final_release/tournament_results.txt
        cat tournament_results.csv >> final_release/tournament_results.txt

    - name: Create release directory
      run: |
        mkdir -p final_release
        # Copy all executables to final release directory
        find . -name "chess-engines-*" -type d | while read dir; do
          cp "$dir"/* final_release/ 2>/dev/null || true
        done
        # Also copy the opening book from the repository into the final release (if present)
        if [ -f src/engines/book/opening_book.db ]; then
          cp src/engines/book/opening_book.db final_release/ || true
        fi
        if [ -f src/engines/book/opening_book_rare.db ]; then
          cp src/engines/book/opening_book_rare.db final_release/ || true
        fi
        # List files for debugging
        ls -la final_release/

    - name: Create ZIP archives
      run: |
        cd final_release
        
        # Create individual ZIP files for each platform
        if ls *windows* 1> /dev/null 2>&1; then
          zip -r ../weak-chess-engines-windows.zip *windows*
        fi
        
        if ls *ubuntu* 1> /dev/null 2>&1; then
          zip -r ../weak-chess-engines-linux.zip *ubuntu*
        fi
        
        
        # Create a complete package with all platforms
        cd ..
        zip -r weak-chess-engines-all-platforms.zip final_release/

    - name: Get version and notes
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "NOTES=${{ github.event.inputs.notes }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "NOTES=" >> $GITHUB_OUTPUT
        fi

    - name: Generate tournament tables
      id: tournament_table
      run: |
        # Use the generator script to produce full markdown and three parts
        python scripts/generate_tournament_tables.py

        # Emit the three parts into GITHUB_OUTPUT
        echo "table_part1<<TOURNAMENT_TABLE_PART1_EOF" >> $GITHUB_OUTPUT
        cat final_release/table_part1.txt >> $GITHUB_OUTPUT || true
        echo "TOURNAMENT_TABLE_PART1_EOF" >> $GITHUB_OUTPUT

        echo "table_part2<<TOURNAMENT_TABLE_PART2_EOF" >> $GITHUB_OUTPUT
        cat final_release/table_part2.txt >> $GITHUB_OUTPUT || true
        echo "TOURNAMENT_TABLE_PART2_EOF" >> $GITHUB_OUTPUT

        echo "table_part3<<TOURNAMENT_TABLE_PART3_EOF" >> $GITHUB_OUTPUT
        cat final_release/table_part3.txt >> $GITHUB_OUTPUT || true
        echo "TOURNAMENT_TABLE_PART3_EOF" >> $GITHUB_OUTPUT

      shell: bash

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        release_name: Weak Chess Engines ${{ steps.get_version.outputs.VERSION }}
        body: |
          # Weak Chess Engines Release ${{ steps.get_version.outputs.VERSION }}

          # Release Notes for this Version:

          ${{ steps.get_version.outputs.NOTES }}

          # General Information

          This release contains UCI-compatible chess engines designed to play intentionally weak chess for testing, learning and entertainment.

          ## Engines Included:

          - **Random Engine**: Plays completely random legal moves
          - **Alphabetical Engine**: Always picks the first move alphabetically (by SAN)
          - **Reverse Alphabetical Engine**: Always picks the last move alphabetically (by SAN)
          - **Pi Engine**: Uses Pi's fractional part to pick a move index (~14% through the list)
          - **Euler Engine**: Uses e's fractional part to pick a move index (~72% through the list)
          - **Suicide King**: Aggressively moves the king toward the opponent's king
          - **Blunder Engine**: Intentionally searches for and plays very bad moves
          - **Greedy Capture Engine**: Always captures when possible, ignoring safety
          - **Shuffle Engine**: Moves pieces back and forth, wasting tempo
          - **Anti-Positional Engine**: Deliberately violates positional principles
          - **Color Square Engine**: Tries to move all its pieces onto squares matching its own color (white or black).
          - **Opposite Color Square Engine**: Tries to move all its pieces onto squares matching the opponent's color (white or black).
          - **Swarm Engine**: Coordinates multiple pieces to swarm the opponent's position.
          - **Huddle Engine**: Groups pieces together for mutual support and defense.
          - **Runaway Engine**: Attempts to escape from threats by moving pieces away from danger.
          - **Mirror Y Engine**: Mirrors opponent's moves along the Y-axis.
          - **Mirror X Engine**: Mirrors opponent's moves along the X-axis.
          - **Reverse Start Engine**: Starts with pieces in reverse order and plays accordingly.
          - **CCCP Engine**: A quirky engine that plays in a Soviet-themed style. checkmate, check, capture and push.
          - **Passafist Engine**: An engine that prefers to pass its turn whenever possible, leading to very passive play.
          - **Single Player Engine**: An classical basic engine but thinks it's only allowed to make moves and not the opponent.
          - **Strangler Engine**: An engine that focuses minimizing its opponents moves in the next turn.
          - **Mover Engine**: An engine that focuses on moving pieces towards the center of the board.
          - **Opening Book Engine**: An engine that plays moves from a predefined opening book.
          - **Rare Opening Book Engine**: An engine that plays moves from a rare and uncommon opening book.
          - **Lawyer Engine**: Tries to maximize its legal moves.
          - **Criminal Engine**: Tries to minimize its own legal moves.
          - **Paralegal Engine**: This engine tries to maximize it's opponent's legal moves.

          ## Tournament Results

          ${{ steps.tournament_table.outputs.table_part1 }}
          ${{ steps.tournament_table.outputs.table_part2 }}
          ${{ steps.tournament_table.outputs.table_part3 }}

          ðŸ“Š **Full tournament results with all engines are also available in the release assets:**
          - `tournament_results.md` - Full markdown table with all engines
          - `tournament_results.csv` - Raw CSV data
          - `tournament_games.pgn` - All game records in PGN format

          ## Platform Support:

          - Windows (x64)
          - Linux (x64)

          ## Usage:

          1. Download the appropriate ZIP for your platform from this release
          2. Extract the executable(s) and run or register them in any UCI-compatible GUI
          3. Optionally copy the executables into your chess GUI engines folder

          ## Notes:

          - These engines are intentionally weak and meant for testing, education and fun.
          - If you need macOS builds later, we can re-add macOS to the matrix.
        draft: false
        prerelease: false

    - name: Upload Windows Release Asset
      if: hashFiles('weak-chess-engines-windows.zip') != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./weak-chess-engines-windows.zip
        asset_name: weak-chess-engines-windows.zip
        asset_content_type: application/zip

    - name: Upload Linux Release Asset
      if: hashFiles('weak-chess-engines-linux.zip') != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./weak-chess-engines-linux.zip
        asset_name: weak-chess-engines-linux.zip
        asset_content_type: application/zip


    - name: Upload All Platforms Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./weak-chess-engines-all-platforms.zip
        asset_name: weak-chess-engines-all-platforms.zip
        asset_content_type: application/zip

    - name: Upload Tournament Results Markdown
      if: hashFiles('final_release/tournament_results.md') != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./final_release/tournament_results.md
        asset_name: tournament_results.md
        asset_content_type: text/markdown

    - name: Upload Tournament Results CSV
      if: hashFiles('final_release/tournament_results.csv') != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./final_release/tournament_results.csv
        asset_name: tournament_results.csv
        asset_content_type: text/csv

    - name: Upload Tournament Games PGN
      if: hashFiles('final_release/tournament_games.pgn') != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./final_release/tournament_games.pgn
        asset_name: tournament_games.pgn
        asset_content_type: text/plain