name: Build and Release Chess Engines

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number for the release'
        required: true
        default: 'v1.0.0'
      notes:
        description: 'Additional release notes/comments'
        required: false
        default: ''

# Grant the workflow permission to create releases using GITHUB_TOKEN
permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
        python-version: ['3.9']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build executables
      run: |
        # Create dist directory
        mkdir -p dist
        
        # Build each engine
        pyinstaller --onefile --name random_engine_${{ matrix.os }} scripts/random_engine.py
        pyinstaller --onefile --name alphabetical_engine_${{ matrix.os }} scripts/alphabetical_engine.py
        pyinstaller --onefile --name reverse_alphabetical_engine_${{ matrix.os }} scripts/reverse_alphabetical_engine.py
        pyinstaller --onefile --name pi_engine_${{ matrix.os }} scripts/pi_engine.py
        pyinstaller --onefile --name euler_engine_${{ matrix.os }} scripts/euler_engine.py
        pyinstaller --onefile --name suicide_king_engine_${{ matrix.os }} scripts/suicide_king_engine.py
        pyinstaller --onefile --name blunder_engine_${{ matrix.os }} scripts/blunder_engine.py
        pyinstaller --onefile --name greedy_capture_engine_${{ matrix.os }} scripts/greedy_capture_engine.py
        pyinstaller --onefile --name shuffle_engine_${{ matrix.os }} scripts/shuffle_engine.py
        pyinstaller --onefile --name anti_positional_engine_${{ matrix.os }} scripts/anti_positional_engine.py
        pyinstaller --onefile --name color_square_engine_${{ matrix.os }} scripts/color_square_engine.py

    - name: Prepare artifacts (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # Create release directory
        mkdir release
        
        # Copy executables and rename with .exe extension
        copy "dist\random_engine_${{ matrix.os }}.exe" "release\random_engine_windows.exe"
        copy "dist\alphabetical_engine_${{ matrix.os }}.exe" "release\alphabetical_engine_windows.exe"
        copy "dist\reverse_alphabetical_engine_${{ matrix.os }}.exe" "release\reverse_alphabetical_engine_windows.exe"
        copy "dist\pi_engine_${{ matrix.os }}.exe" "release\pi_engine_windows.exe"
        copy "dist\euler_engine_${{ matrix.os }}.exe" "release\euler_engine_windows.exe"
        copy "dist\suicide_king_engine_${{ matrix.os }}.exe" "release\suicide_king_engine_windows.exe"
        copy "dist\blunder_engine_${{ matrix.os }}.exe" "release\blunder_engine_windows.exe"
        copy "dist\greedy_capture_engine_${{ matrix.os }}.exe" "release\greedy_capture_engine_windows.exe"
        copy "dist\shuffle_engine_${{ matrix.os }}.exe" "release\shuffle_engine_windows.exe"
        copy "dist\anti_positional_engine_${{ matrix.os }}.exe" "release\anti_positional_engine_windows.exe"
        copy "dist\color_square_engine_${{ matrix.os }}.exe" "release\color_square_engine_windows.exe"

    - name: Prepare artifacts (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Create release directory
        mkdir -p release
        
        # Copy executables with proper naming
        cp "dist/random_engine_${{ matrix.os }}" "release/random_engine_linux"
        cp "dist/alphabetical_engine_${{ matrix.os }}" "release/alphabetical_engine_linux"
        cp "dist/reverse_alphabetical_engine_${{ matrix.os }}" "release/reverse_alphabetical_engine_linux"
        cp "dist/pi_engine_${{ matrix.os }}" "release/pi_engine_linux"
        cp "dist/euler_engine_${{ matrix.os }}" "release/euler_engine_linux"
        cp "dist/suicide_king_engine_${{ matrix.os }}" "release/suicide_king_engine_linux"
        cp "dist/blunder_engine_${{ matrix.os }}" "release/blunder_engine_linux"
        cp "dist/greedy_capture_engine_${{ matrix.os }}" "release/greedy_capture_engine_linux"
        cp "dist/shuffle_engine_${{ matrix.os }}" "release/shuffle_engine_linux"
        cp "dist/anti_positional_engine_${{ matrix.os }}" "release/anti_positional_engine_linux"
        cp "dist/color_square_engine_${{ matrix.os }}" "release/color_square_engine_linux"
        
        # Make executables... executable
        chmod +x release/*

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: chess-engines-${{ matrix.os }}
        path: release/

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4


    - name: Install tournament dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-chess

    - name: Run Tournament and Export Results
      run: |
        python tournament.py
        mkdir -p final_release
        cp tournament_results.csv final_release/
        cp tournament_games.pgn final_release/
        echo "Tournament results:" > final_release/tournament_results.txt
        cat tournament_results.csv >> final_release/tournament_results.txt

    - name: Create release directory
      run: |
        mkdir -p final_release
        # Copy all executables to final release directory
        find . -name "chess-engines-*" -type d | while read dir; do
          cp "$dir"/* final_release/ 2>/dev/null || true
        done
        # List files for debugging
        ls -la final_release/

    - name: Create ZIP archives
      run: |
        cd final_release
        
        # Create individual ZIP files for each platform
        if ls *windows* 1> /dev/null 2>&1; then
          zip -r ../weak-chess-engines-windows.zip *windows*
        fi
        
        if ls *ubuntu* 1> /dev/null 2>&1; then
          zip -r ../weak-chess-engines-linux.zip *ubuntu*
        fi
        
        
        # Create a complete package with all platforms
        cd ..
        zip -r weak-chess-engines-all-platforms.zip final_release/

    - name: Get version and notes
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "NOTES=${{ github.event.inputs.notes }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "NOTES=" >> $GITHUB_OUTPUT
        fi

    - name: Convert Tournament Table to Markdown
      id: tournament_table
      run: |
        {
          echo 'table<<EOF'
          # Read CSV and convert to markdown
          {
            read -r header
            # Print header row
              IFS=',' read -ra cols <<< "$header"
              printf '|'; for col in "${cols[@]}"; do printf ' %s |' "$col"; done; printf '\n'
            # Print separator
              printf '|'; for col in "${cols[@]}"; do printf ' --- |'; done; printf '\n'
            # Print data rows
            while IFS=',' read -r col1 col2 col3 col4 col5; do
              printf '| %s | %s | %s | %s | %s |\n' "$col1" "$col2" "$col3" "$col4" "$col5"
            done
          } < final_release/tournament_results.csv
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        release_name: Weak Chess Engines ${{ steps.get_version.outputs.VERSION }}
        body: |
          # Weak Chess Engines Release ${{ steps.get_version.outputs.VERSION }}

          # Release Notes for this Version:

          ${{ steps.get_version.outputs.NOTES }}

          # General Information

          This release contains UCI-compatible chess engines designed to play intentionally weak chess for testing, learning and entertainment.

          ## Engines Included:

          - **Random Engine**: Plays completely random legal moves
          - **Alphabetical Engine**: Always picks the first move alphabetically (by SAN)
          - **Reverse Alphabetical Engine**: Always picks the last move alphabetically (by SAN)
          - **Pi Engine**: Uses Pi's fractional part to pick a move index (~14% through the list)
          - **Euler Engine**: Uses e's fractional part to pick a move index (~72% through the list)
          - **Suicide King**: Aggressively moves the king toward the opponent's king
          - **Blunder Engine**: Intentionally searches for and plays very bad moves
          - **Greedy Capture Engine**: Always captures when possible, ignoring safety
          - **Shuffle Engine**: Moves pieces back and forth, wasting tempo
          - **Anti-Positional Engine**: Deliberately violates positional principles
          - **Color Square Engine**: Tries to move all its pieces onto squares matching its own color (white or black).

          ## Tournament Results

          ${{ steps.tournament_table.outputs.table }}

          ## Platform Support:

          - Windows (x64)
          - Linux (x64)

          ## Usage:

          1. Download the appropriate ZIP for your platform from this release
          2. Extract the executable(s) and run or register them in any UCI-compatible GUI
          3. Optionally copy the executables into your chess GUI engines folder

          ## Notes:

          - These engines are intentionally weak and meant for testing, education and fun.
          - If you need macOS builds later, we can re-add macOS to the matrix.
        draft: false
        prerelease: false

    - name: Upload Windows Release Asset
      if: hashFiles('weak-chess-engines-windows.zip') != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./weak-chess-engines-windows.zip
        asset_name: weak-chess-engines-windows.zip
        asset_content_type: application/zip

    - name: Upload Linux Release Asset
      if: hashFiles('weak-chess-engines-linux.zip') != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./weak-chess-engines-linux.zip
        asset_name: weak-chess-engines-linux.zip
        asset_content_type: application/zip


    - name: Upload All Platforms Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./weak-chess-engines-all-platforms.zip
        asset_name: weak-chess-engines-all-platforms.zip
        asset_content_type: application/zip